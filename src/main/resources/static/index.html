<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Gest√£o de Institui√ß√µes - Com Lista de Gestores</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        background-color: #f8f9fa;
      }
      header {
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      h1 {
        color: #007bff;
      }
      .container {
        display: flex;
        gap: 30px;
      }
      .section-box {
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #fff;
        margin-bottom: 20px;
      }
      #super-admin-section .container {
        flex-direction: row;
      }
      #institution-dashboard-section .container {
        flex-direction: column;
        max-width: 800px;
        margin: 0 auto;
      }
      #institution-login-section {
        max-width: 400px;
        margin: 0 auto;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="text"],
      input[type="password"],
      textarea,
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        padding: 10px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      button:hover {
        background-color: #218838;
      }
      .delete-btn {
        background-color: #dc3545;
      }
      .pdf-btn {
        background-color: #007bff;
      }
      .refresh-btn {
        background-color: #6c757d;
      }
      .list-group {
        list-style: none;
        padding: 0;
      }
      .list-group-item {
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #message {
        margin-top: 20px;
        padding: 10px;
        border-radius: 4px;
        display: none;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
      }
      .hidden {
        display: none;
      }
      .login-btn {
        background-color: #4caf50;
      }
      .gestor-info {
        font-size: 14px;
        color: #666;
      }
      .school-item {
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Gest√£o de Institui√ß√µes</h1>
      <p>
        Endpoint Base: <strong>http://localhost:8080/api/instituicoes</strong>
      </p>
      <p id="auth-status" style="font-weight: bold; color: red">
        üî¥ N√≠vel de Acesso: Super Admin (N√≠vel 1)
      </p>
      <button onclick="changeView('super-admin')" class="pdf-btn">
        Acesso Super Admin
      </button>
      <button onclick="changeView('institution-login')" class="login-btn">
        Acesso Institui√ß√£o (N√≠vel 2)
      </button>
      <button
        id="logout-btn"
        onclick="logoutInstitution()"
        class="delete-btn hidden"
      >
        Sair (Institui√ß√£o)
      </button>
    </header>

    <div id="message" class="hidden"></div>

    <section id="super-admin-section" class="section-box">
      <h2>Super Admin - Gest√£o de Institui√ß√µes Mestre</h2>
      <div class="container">
        <section style="flex: 1">
          <h3>Criar Institui√ß√£o</h3>
          <form id="form-criar">
            <div class="form-group">
              <label for="nome">Nome (Chave de Login):</label>
              <input type="text" id="nome" required />
            </div>
            <div class="form-group">
              <label for="cnpj">CNPJ:</label>
              <input type="text" id="cnpj" required />
            </div>
            <div class="form-group">
              <label for="inst-senha">Senha da Institui√ß√£o:</label>
              <input type="password" id="inst-senha" required />
            </div>
            <button type="submit">Criar Institui√ß√£o</button>
          </form>
        </section>

        <section style="flex: 1">
          <h3>Institui√ß√µes Cadastradas</h3>
          <button onclick="downloadReportPdf()" class="pdf-btn">
            Baixar Relat√≥rio (PDF)
          </button>
          <button onclick="fetchInstitutions()" class="refresh-btn">
            Recarregar Lista
          </button>
          <ul id="lista-instituicoes" class="list-group">
            <li>Carregando...</li>
          </ul>
        </section>
      </div>
    </section>

    <section id="institution-login-section" class="section-box hidden">
      <h2>üîë Login da Institui√ß√£o</h2>
      <form id="form-institution-login">
        <div class="form-group">
          <label for="login-login">Nome da Institui√ß√£o:</label>
          <input type="text" id="login-login" required />
        </div>
        <div class="form-group">
          <label for="login-senha">Senha:</label>
          <input type="password" id="login-senha" required />
        </div>
        <button type="submit" style="background-color: #007bff">Entrar</button>
      </form>
    </section>

    <section id="institution-dashboard-section" class="section-box hidden">
      <h2 id="dashboard-title">Dashboard - Institui√ß√£o: [Nome]</h2>
      <p style="color: blue; font-weight: bold">
        ID da Institui√ß√£o Logada: <span id="logged-institution-id"></span>
      </p>

      <div class="container">
        <section style="flex: 1">
          <h3>Cadastrar Novo Gestor üßë‚Äçüíº</h3>
          <form id="form-create-gestor">
            <div class="form-group">
              <label for="gestor-nome">Nome:</label>
              <input type="text" id="gestor-nome" required />
            </div>
            <div class="form-group">
              <label for="gestor-email">Email (Login):</label>
              <input type="text" id="gestor-email" required />
            </div>
            <div class="form-group">
              <label for="gestor-senha">Senha:</label>
              <input type="password" id="gestor-senha" required />
            </div>
            <button type="submit" style="background-color: #ff8c00">
              Cadastrar Gestor
            </button>
          </form>
        </section>

        <section style="flex: 1">
          <h3>Cadastrar Nova Escola üè´</h3>
          <form id="form-add-school">
            <div class="form-group">
              <label for="school-nome">Nome da Escola:</label>
              <input type="text" id="school-nome" required />
            </div>
            <div class="form-group">
              <label for="school-gestor">Gestor Respons√°vel:</label>
              <select id="school-gestor" required>
                <option value="">Carregando Gestores...</option>
              </select>
              <small style="color: #666"
                >Se n√£o aparecer gestores, cadastre um primeiro</small
              >
            </div>
            <div class="form-group">
              <label for="school-cidade">Cidade:</label>
              <input type="text" id="school-cidade" required />
            </div>
            <div class="form-group">
              <label for="school-alunos">N√∫mero de Alunos:</label>
              <input
                type="number"
                id="school-alunos"
                min="0"
                value="0"
                required
              />
            </div>
            <button type="submit" style="background-color: #007bff">
              Cadastrar Escola
            </button>
          </form>
        </section>
      </div>

      <hr />
      <h3>Gestores e Escolas Cadastradas</h3>
      <button
        onclick="fetchGestores(INSTITUICAO_LOGADA.id)"
        class="refresh-btn"
      >
        üîÑ Recarregar Gestores
      </button>
      <button onclick="fetchSchools(INSTITUICAO_LOGADA.id)" class="refresh-btn">
        üîÑ Recarregar Escolas
      </button>

      <div class="container" style="margin-top: 20px">
        <section style="flex: 1; border: 1px dashed #ccc; padding: 10px">
          <h4>üìã Lista de Gestores</h4>
          <div class="gestor-info">
            <strong>Total: <span id="total-gestores">0</span> gestores</strong>
          </div>
          <ul id="lista-gestores" class="list-group">
            <li>Nenhum gestor cadastrado.</li>
          </ul>
        </section>

        <section style="flex: 1; border: 1px dashed #ccc; padding: 10px">
          <h4>üè´ Lista de Escolas</h4>
          <div class="gestor-info">
            <strong>Total: <span id="total-escolas">0</span> escolas</strong>
          </div>
          <ul id="lista-escolas" class="list-group">
            <li>Nenhuma escola cadastrada.</li>
          </ul>
        </section>
      </div>
    </section>

    <script>
      // --- Vari√°veis Globais ---
      const API_URL = "http://localhost:8080/api/instituicoes";
      const AUTH_URL = "http://localhost:8080/api/auth";

      let INSTITUICAO_LOGADA = null;

      // Elementos DOM
      const messageDiv = document.getElementById("message");
      const superAdminSection = document.getElementById("super-admin-section");
      const institutionLoginSection = document.getElementById(
        "institution-login-section"
      );
      const institutionDashboardSection = document.getElementById(
        "institution-dashboard-section"
      );
      const authStatusP = document.getElementById("auth-status");
      const logoutBtn = document.getElementById("logout-btn");

      const listaInstituicoes = document.getElementById("lista-instituicoes");
      const formCriar = document.getElementById("form-criar");

      // Elementos Institui√ß√£o Dashboard
      const formInstitutionLogin = document.getElementById(
        "form-institution-login"
      );
      const formCreateGestor = document.getElementById("form-create-gestor");
      const formAddSchool = document.getElementById("form-add-school");
      const selectGestor = document.getElementById("school-gestor");
      const loggedInstitutionIdSpan = document.getElementById(
        "logged-institution-id"
      );
      const dashboardTitle = document.getElementById("dashboard-title");
      const listaGestores = document.getElementById("lista-gestores");
      const listaEscolas = document.getElementById("lista-escolas");
      const totalGestoresSpan = document.getElementById("total-gestores");
      const totalEscolasSpan = document.getElementById("total-escolas");

      // --- FUN√á√ïES DE UTENS√çLIOS E VISUALIZA√á√ÉO ---

      function showMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.className = type === "success" ? "success" : "error";
        messageDiv.classList.remove("hidden");
        setTimeout(() => {
          messageDiv.classList.add("hidden");
        }, 5000);
      }

      function changeView(view) {
        superAdminSection.classList.add("hidden");
        institutionLoginSection.classList.add("hidden");
        institutionDashboardSection.classList.add("hidden");
        logoutBtn.classList.add("hidden");

        if (view === "super-admin") {
          superAdminSection.classList.remove("hidden");
          authStatusP.innerHTML = "üî¥ N√≠vel de Acesso: Super Admin (N√≠vel 1)";
          fetchInstitutions();
        } else if (view === "institution-login") {
          institutionLoginSection.classList.remove("hidden");
          authStatusP.innerHTML =
            "üî¥ N√≠vel de Acesso: Institui√ß√£o (N√≠vel 2) - Fa√ßa Login";
        } else if (view === "institution-dashboard" && INSTITUICAO_LOGADA) {
          institutionDashboardSection.classList.remove("hidden");
          logoutBtn.classList.remove("hidden");
          dashboardTitle.textContent = `Dashboard - Institui√ß√£o: ${INSTITUICAO_LOGADA.nome}`;
          loggedInstitutionIdSpan.textContent = INSTITUICAO_LOGADA.id;
          authStatusP.innerHTML = `üü¢ N√≠vel de Acesso: Institui√ß√£o Logada - ${INSTITUICAO_LOGADA.nome}`;
          fetchGestores(INSTITUICAO_LOGADA.id);
          fetchSchools(INSTITUICAO_LOGADA.id);
        }
      }

      // --- 1. SUPER ADMIN (CRUD Institui√ß√µes) ---

      formCriar.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nome = document.getElementById("nome").value;
        const cnpj = document.getElementById("cnpj").value;
        const senha = document.getElementById("inst-senha").value;

        const novaInstituicao = {
          nome: nome,
          cnpj: cnpj,
          senha: senha,
          escolas: [],
        };

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(novaInstituicao),
          });

          if (!response.ok) {
            const error = await response.text();
            throw new Error(
              `Falha ao criar: ${response.statusText}. Detalhe: ${error}`
            );
          }

          const data = await response.json();
          showMessage(
            `Institui√ß√£o "${data.nome}" criada com sucesso!`,
            "success"
          );
          formCriar.reset();
          fetchInstitutions();
        } catch (error) {
          showMessage(`Erro ao criar institui√ß√£o: ${error.message}`, "error");
        }
      });

      async function fetchInstitutions() {
        listaInstituicoes.innerHTML = "<li>Carregando...</li>";
        try {
          const response = await fetch(API_URL);
          const data = await response.json();
          listaInstituicoes.innerHTML = "";
          if (data.length === 0) {
            listaInstituicoes.innerHTML =
              "<li>Nenhuma institui√ß√£o cadastrada.</li>";
            return;
          }
          data.forEach((inst) => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.innerHTML = `
                      <div>
                        <strong>${inst.nome}</strong> 
                        <small>| ID: ${inst.id}</small>
                      </div>
                      <div>
                        <button onclick="deleteInstitution('${inst.id}')" class="delete-btn">Deletar</button>
                      </div>
                    `;
            listaInstituicoes.appendChild(li);
          });
        } catch (error) {
          listaInstituicoes.innerHTML = `<li class="error">Falha ao conectar: ${error.message}.</li>`;
        }
      }

      async function deleteInstitution(id) {
        if (
          !window.confirm(
            `Tem certeza que deseja deletar a institui√ß√£o com ID ${id}?`
          )
        )
          return;
        try {
          const response = await fetch(`${API_URL}/${id}`, {
            method: "DELETE",
          });
          if (response.status === 204) {
            showMessage(`Institui√ß√£o ${id} deletada com sucesso!`, "success");
            fetchInstitutions();
          } else {
            throw new Error(`Status ${response.status} ao deletar.`);
          }
        } catch (error) {
          showMessage(`Erro ao deletar: ${error.message}`, "error");
        }
      }

      async function downloadReportPdf() {
        try {
          window.open(`${API_URL}/download/pdf`, "_blank");
        } catch (error) {
          showMessage(`Erro ao iniciar download: ${error.message}`, "error");
        }
      }

      // --- 2. LOGIN DA INSTITUI√á√ÉO ---

      formInstitutionLogin.addEventListener("submit", async (e) => {
        e.preventDefault();
        const login = document.getElementById("login-login").value;
        const senha = document.getElementById("login-senha").value;

        try {
          const response = await fetch(`${AUTH_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome: login, senha: senha }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Falha de Login: ${errorText || response.statusText}`
            );
          }

          INSTITUICAO_LOGADA = await response.json();
          console.log("‚úÖ Login bem-sucedido:", INSTITUICAO_LOGADA);

          showMessage(
            `Login bem-sucedido! Bem-vindo, ${INSTITUICAO_LOGADA.nome}.`,
            "success"
          );
          formInstitutionLogin.reset();
          changeView("institution-dashboard");
        } catch (error) {
          showMessage(`Erro: ${error.message}.`, "error");
        }
      });

      function logoutInstitution() {
        INSTITUICAO_LOGADA = null;
        showMessage("Deslogado com sucesso!", "success");
        changeView("institution-login");
      }

      // --- 3. DASHBOARD DA INSTITUI√á√ÉO (Cadastros) ---

      // FUN√á√ÉO CRIAR GESTOR
      formCreateGestor.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!INSTITUICAO_LOGADA)
          return showMessage("Fa√ßa login primeiro.", "error");

        const gestorData = {
          nome: document.getElementById("gestor-nome").value,
          email: document.getElementById("gestor-email").value,
          senha_hash: document.getElementById("gestor-senha").value,
        };

        console.log("üì§ Cadastrando gestor:", gestorData);

        const URL_CADASTRO_GESTOR = `${API_URL}/${INSTITUICAO_LOGADA.id}/gestores`;

        try {
          const response = await fetch(URL_CADASTRO_GESTOR, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(gestorData),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Falha ao criar Gestor: ${errorText || response.statusText}`
            );
          }

          const data = await response.json();
          console.log("‚úÖ Gestor criado:", data);

          showMessage(`Gestor "${data.nome}" criado com sucesso!`, "success");
          formCreateGestor.reset();
          fetchGestores(INSTITUICAO_LOGADA.id);
        } catch (error) {
          console.error("üí• Erro:", error);
          showMessage(`Erro ao criar gestor: ${error.message}`, "error");
        }
      });

      // FUN√á√ÉO LISTAR GESTORES - ATUALIZADA
      async function fetchGestores(instituicaoId) {
        listaGestores.innerHTML = "<li>Carregando gestores...</li>";
        selectGestor.innerHTML =
          '<option value="">Carregando gestores...</option>';

        try {
          const URL_LISTA_GESTOR = `${API_URL}/${instituicaoId}/gestores`;
          console.log("üîç Buscando gestores em:", URL_LISTA_GESTOR);

          const response = await fetch(URL_LISTA_GESTOR);

          if (!response.ok) {
            // Se der erro 405, significa que o endpoint GET n√£o est√° implementado
            if (response.status === 405) {
              throw new Error(
                "Endpoint de listagem de gestores n√£o implementado no backend"
              );
            }
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
          }

          const gestores = await response.json();
          console.log("‚úÖ Gestores carregados:", gestores);

          // Atualizar contador
          totalGestoresSpan.textContent = gestores.length;

          // Atualizar lista de gestores
          listaGestores.innerHTML = "";
          if (gestores.length === 0) {
            listaGestores.innerHTML =
              "<li>Nenhum gestor cadastrado. Cadastre o primeiro gestor acima.</li>";
          } else {
            gestores.forEach((g) => {
              const li = document.createElement("li");
              li.className = "list-group-item";
              li.innerHTML = `
                <div>
                  <strong>${g.nome}</strong><br>
                  <small class="gestor-info">üìß ${g.email} | üÜî ${g.id}</small>
                </div>
                <div>
                  <button onclick="deleteGestor('${instituicaoId}', '${g.id}')" class="delete-btn">Deletar</button>
                </div>
              `;
              listaGestores.appendChild(li);
            });
          }

          // Atualizar select de gestores para cadastro de escolas
          selectGestor.innerHTML =
            '<option value="">Selecione um gestor respons√°vel</option>';
          if (gestores.length === 0) {
            selectGestor.innerHTML +=
              '<option value="" disabled>Nenhum gestor cadastrado</option>';
          } else {
            gestores.forEach((g) => {
              const option = document.createElement("option");
              option.value = g.id;
              option.textContent = `${g.nome} (${g.email})`;
              selectGestor.appendChild(option);
            });
          }
        } catch (error) {
          console.error("‚ùå Erro ao carregar gestores:", error);
          listaGestores.innerHTML = `<li class="error">${error.message}</li>`;
          selectGestor.innerHTML =
            '<option value="">Erro ao carregar gestores</option>';
        }
      }

      // FUN√á√ÉO DELETAR GESTOR
      async function deleteGestor(instituicaoId, gestorId) {
        if (!window.confirm(`Tem certeza que deseja deletar este gestor?`))
          return;

        try {
          const response = await fetch(
            `${API_URL}/${instituicaoId}/gestores/${gestorId}`,
            {
              method: "DELETE",
            }
          );

          if (response.status === 204) {
            showMessage(`Gestor deletado com sucesso!`, "success");
            fetchGestores(instituicaoId);
          } else {
            throw new Error(`Erro ao deletar: Status ${response.status}`);
          }
        } catch (error) {
          showMessage(`Erro ao deletar gestor: ${error.message}`, "error");
        }
      }

      // FUN√á√ÉO LISTAR ESCOLAS
      async function fetchSchools(instituicaoId) {
        listaEscolas.innerHTML = "<li>Carregando escolas...</li>";
        try {
          const url = `${API_URL}/${instituicaoId}/escolas`;
          const response = await fetch(url);

          if (!response.ok) {
            if (response.status === 405) {
              throw new Error(
                "Endpoint de listagem de escolas n√£o implementado no backend"
              );
            }
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
          }

          const escolas = await response.json();

          // Atualizar contador
          totalEscolasSpan.textContent = escolas.length;

          listaEscolas.innerHTML = "";
          if (escolas.length === 0) {
            listaEscolas.innerHTML = "<li>Nenhuma escola cadastrada.</li>";
          } else {
            escolas.forEach((e) => {
              const li = document.createElement("li");
              li.className = "school-item";
              li.innerHTML = `
                <strong>${e.nome}</strong><br>
                <small>üìç ${e.cidade} | üë• ${e.numeroDeAlunos} alunos</small>
                ${
                  e.gestorId
                    ? `<br><small>üë®‚Äçüíº Gestor ID: ${e.gestorId}</small>`
                    : ""
                }
              `;
              listaEscolas.appendChild(li);
            });
          }
        } catch (error) {
          console.error("‚ùå Erro ao carregar escolas:", error);
          listaEscolas.innerHTML = `<li class="error">${error.message}</li>`;
        }
      }

      // FUN√á√ÉO ADICIONAR ESCOLA
      formAddSchool.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!INSTITUICAO_LOGADA)
          return showMessage("Fa√ßa login primeiro.", "error");

        const gestorId = selectGestor.value;
        if (!gestorId)
          return showMessage("Selecione um gestor respons√°vel.", "error");

        const novaEscola = {
          nome: document.getElementById("school-nome").value,
          cidade: document.getElementById("school-cidade").value,
          numeroDeAlunos: parseInt(
            document.getElementById("school-alunos").value
          ),
        };

        const escolaRequestDTO = {
          escola: novaEscola,
          gestorId: gestorId,
        };

        console.log("üì§ Cadastrando escola:", escolaRequestDTO);

        try {
          const response = await fetch(
            `${API_URL}/${INSTITUICAO_LOGADA.id}/escolas`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(escolaRequestDTO),
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Falha ao cadastrar escola: ${errorText}`);
          }

          showMessage(
            `Escola "${novaEscola.nome}" cadastrada com sucesso!`,
            "success"
          );
          formAddSchool.reset();
          fetchSchools(INSTITUICAO_LOGADA.id);
        } catch (error) {
          console.error("‚ùå Erro ao cadastrar escola:", error);
          showMessage(`Erro ao cadastrar escola: ${error.message}`, "error");
        }
      });

      // --- Inicializa√ß√£o ---
      changeView("super-admin");
    </script>
  </body>
</html>
